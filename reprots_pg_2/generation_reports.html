<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generation Reports</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style_generation_reports.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-menu">
                <div class="menu-item">
                    <div class="menu-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
                        </svg>
                        <span>Historical Data</span>
                    </div>
                </div>
                <!-- Collapsed submenu for data selection since we are on reports page -->
                <div class="submenu plain">
                    <a href="index.html" class="submenu-item" style="text-decoration: none; display: block;">Data
                        Selection</a>
                    <a href="index_1.html" class="submenu-item" style="text-decoration: none; display: block;">My
                        Template</a>
                </div>

                <div class="menu-item active" id="menu-reports" style="cursor: pointer;">
                    <div class="menu-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <span>Generation Reports</span>
                    </div>
                </div>

                <div class="menu-item" id="menu-statistics" style="cursor: pointer;">
                    <div class="menu-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <span>Statistics</span>
                    </div>
                </div>
                <div class="submenu plain">
                    <div class="submenu-item">Monthly</div>
                    <div class="submenu-item">Annual</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">

                <!-- Helper Tab -->
                <div class="gen-tabs-container">
                    <div class="gen-tab">Plant</div>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <!-- Reports Mode Search Group -->
                    <div class="search-group" id="search-group-reports">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <div class="search-input-wrapper">
                            <div id="search-tags-container"></div>
                            <input type="text" class="search-input-field" placeholder="Please enter plant / SN / email">
                        </div>
                    </div>

                    <!-- Statistics Mode Location Group -->
                    <div class="location-group" id="search-group-statistics"
                        style="display: none; display: flex; gap: 10px;">
                        <select class="filter-select location-select" id="dynamic-location-select"
                            style="min-width: 200px;">
                            <option value="">Select Region</option>
                            <option value="india">India</option>
                            <option value="nigeria">Nigeria</option>
                            <option value="global">Global</option>
                        </select>
                    </div>

                    <!-- Reports Mode Filter -->
                    <select class="filter-select" id="filter-report-type">
                        <option>Daily Report</option>
                        <option>Monthly Report</option>
                        <option>Annual Report</option>
                        <option>User-defined Report</option>
                        <option>Simulation Report</option>
                    </select>

                    <!-- Statistics Mode Organization -->
                    <select class="filter-select" id="filter-organization" style="display: none;">
                        <option value="">Select Organization</option>
                        <option>SolarTech Solutions</option>
                        <option>Green Energy Corp</option>
                        <option>Eco Power Systems</option>
                        <option>Alpha Solar</option>
                    </select>

                    <input type="text" class="filter-date-input" id="filter-date-input" placeholder="Please Select Date"
                        onfocus="(this.type='date')" onblur="(this.type='text')">

                    <div class="btns-container">
                        <button class="btn-generate" id="btn-generate-report">Generate Report</button>
                        <div class="export-btn-wrapper">
                            <button class="btn-export-gray" id="btn-export">Export</button>
                            <div class="export-popup" id="export-popup">
                                <div class="popup-arrow"></div>
                                <div class="popup-text">Daily report is only available for plants with load monitoring
                                    function which is enabled by HomeKit or SEC1000.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Display Area -->
                <div class="reports-display-area">
                    <!-- Default State: No Data Illustration -->
                    <!-- Default State: No Data Illustration -->
                    <div class="no-data-illustration" id="no-data-view">
                        <!-- Content removed as per user request -->
                    </div>

                    <!-- Results View: Graph and Table -->
                    <div id="report-results-view"
                        style="display: none; flex-direction: column; width: 100%; gap: 30px;">

                        <!-- Graph Section -->
                        <div class="chart-section"
                            style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                            <canvas id="reportChart" style="width: 100%; height: 350px;"></canvas>
                        </div>

                        <!-- Table Section -->
                        <div class="table-section">
                            <div class="section-header" id="results-table-header"
                                style="background: #f1f1f1; padding: 12px 15px; border-radius: 8px 8px 0 0; font-weight: bold; color: #333; font-size: 16px; border-bottom: 2px solid #00875a;">
                                Statistics
                            </div>
                            <div class="table-responsive">
                                <table class="custom-table"
                                    style="width: 100%; border-collapse: collapse; border: 1px solid #e0e0e0;">
                                    <thead style="background-color: #00875a; color: white;" id="report-table-head">
                                        <!-- Header generated by JS -->
                                    </thead>
                                    <tbody id="report-table-body">
                                        <!-- Rows generated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Step 2: "Spice" / Continuous Content (Initially Hidden) -->
                        <div id="results-step-2"
                            style="display: none; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee;">
                            <div
                                style="font-size: 18px; font-weight: bold; color: #00875a; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                                Spice / Continuous Monitoring
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 15px; color: #555;">
                                <p>Dynamic continuous data and monitoring indicators will be displayed in this section.
                                    This view provides a real-time perspective on the generated statistics.</p>
                                <div
                                    style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 10px;">
                                    <div
                                        style="padding: 15px; background: #f9f9f9; border-radius: 6px; border-left: 4px solid #00875a;">
                                        <div style="font-size: 12px; color: #888;">Live Performance</div>
                                        <div style="font-size: 20px; font-weight: bold; color: #333;">98.4%</div>
                                    </div>
                                    <div
                                        style="padding: 15px; background: #f9f9f9; border-radius: 6px; border-left: 4px solid #00875a;">
                                        <div style="font-size: 12px; color: #888;">Current Voltage</div>
                                        <div style="font-size: 20px; font-weight: bold; color: #333;">230.5V</div>
                                    </div>
                                    <div
                                        style="padding: 15px; background: #f9f9f9; border-radius: 6px; border-left: 4px solid #00875a;">
                                        <div style="font-size: 12px; color: #888;">Frequency</div>
                                        <div style="font-size: 20px; font-weight: bold; color: #333;">50.02 Hz</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Action -->
                        <div style="display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px;">
                            <button class="ps-btn ps-btn-cancel" id="btn-prev-step"
                                style="width: 120px; display: none; background: #f5f5f5; color: #666; border: 1px solid #ddd;">Previous</button>
                            <button class="ps-btn ps-btn-confirm" id="btn-next-step" style="width: 120px;">Next</button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Plant Selection Modal -->
    <div class="modal-overlay" id="plant-modal-overlay">
        <div class="plant-selection-modal">
            <!-- Header with Tabs and Search -->
            <div class="ps-header">
                <div class="ps-tabs">
                    <div class="ps-tab active">Plant</div>
                    <div class="ps-tab">SN</div>
                    <div class="ps-tab">Location</div>
                    <div class="ps-tab">Organization</div>
                </div>
                <div class="ps-search-container">
                    <!-- Using specific SVG for search icon inside modal if needed, or simple placeholder -->
                    <svg style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #9e9e9e; width: 14px; height: 14px;"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" class="ps-search-input" placeholder="Please enter plant name">
                </div>
            </div>

            <!-- Body with Dual Panes -->
            <div class="ps-body">
                <div id="view-plant" style="display: flex; gap: 20px; width: 100%;">
                    <!-- Left Panel: Select Plant -->
                    <div class="ps-panel">
                        <div class="ps-panel-header">
                            <span>Select plant</span>
                        </div>
                        <div class="ps-helper-banner">
                            To make the selection, click <i class="fa-solid fa-file-circle-plus"
                                style="color: #00bfa5;"></i>
                            <div class="ps-help-container">
                                <span class="ps-help-icon">?</span>
                                <div class="ps-note">
                                    Daily report is only available for plants with load monitoring function which is
                                    enabled by HomeKit or SEC1000.
                                </div>
                            </div>
                        </div>
                        <div class="ps-list-content" id="ps-source-list">
                            <!-- Items will be injected here -->
                        </div>
                    </div>

                    <!-- Right Panel: Selected List -->
                    <div class="ps-panel">
                        <div class="ps-panel-header">
                            <span>Selected list</span>
                            <button class="btn-clear-all" id="btn-clear-selection">Clear All</button>
                        </div>
                        <div class="ps-helper-banner" style="position: relative;">
                            To cancel the selection, click <i class="fa-solid fa-trash-can" style="color: #ff5722;"></i>
                        </div>
                        <div class="ps-list-content" id="ps-selected-list">
                            <!-- Items will be injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="ps-footer">
                <button class="ps-btn ps-btn-cancel" id="btn-cancel-modal">Cancel</button>
                <button class="ps-btn ps-btn-confirm" id="btn-confirm-modal">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Mode State
            let currentMode = 'reports'; // 'reports' or 'statistics'

            // Mode Switching Logic
            const menuReports = document.getElementById('menu-reports');
            const menuStatistics = document.getElementById('menu-statistics');
            const searchReports = document.getElementById('search-group-reports');
            const searchStatistics = document.getElementById('search-group-statistics');
            const filterReportType = document.getElementById('filter-report-type');
            const filterOrganization = document.getElementById('filter-organization');
            const dateInput = document.getElementById('filter-date-input');
            const genTabLabel = document.querySelector('.gen-tab');

            function switchMode(mode) {
                currentMode = mode;
                if (mode === 'reports') {
                    menuReports.classList.add('active');
                    menuStatistics.classList.remove('active');
                    searchReports.style.display = 'flex';
                    searchStatistics.style.display = 'none';
                    filterReportType.style.display = 'block';
                    filterOrganization.style.display = 'none';
                    dateInput.placeholder = "Please Select Date";
                    dateInput.type = 'text';
                    dateInput.onfocus = function () { this.type = 'date'; };
                    dateInput.onblur = function () { this.type = 'text'; };
                    genTabLabel.textContent = 'Plant';
                } else {
                    menuStatistics.classList.add('active');
                    menuReports.classList.remove('active');
                    searchReports.style.display = 'none';
                    searchStatistics.style.display = 'flex';
                    filterReportType.style.display = 'none';
                    filterOrganization.style.display = 'block';
                    dateInput.placeholder = "Please Select Month";
                    dateInput.type = 'month'; // Direct month type for statistics
                    genTabLabel.textContent = 'Location Statistics';

                    // Reset Dynamic Location
                    locationSelection = { region: '', state: '', district: '' };
                    currentSelectionLevel = 'region';
                    updateDynamicOptions();
                }
                // Reset views
                if (noDataView) noDataView.style.display = 'flex';
                if (resultsView) resultsView.style.display = 'none';
            }

            menuReports.addEventListener('click', () => switchMode('reports'));
            menuStatistics.addEventListener('click', () => switchMode('statistics'));

            // Location Cascading Data
            const locationData = {
                india: {
                    states: {
                        "Kerala": ["Ernakulam", "Trivandrum", "Kozhikode"],
                        "Tamil Nadu": ["Chennai", "Coimbatore", "Madurai"],
                        "Karnataka": ["Bangalore", "Mysore", "Hubli"]
                    }
                },
                nigeria: {
                    states: {
                        "Lagos": ["Ikeja", "Badagry", "Ikorodu"],
                        "Kano": ["Kano Municipal", "Fagge", "Gwale"],
                        "Oyo": ["Ibadan", "Ogbomosho", "Iseyin"]
                    }
                },
                global: {
                    states: {
                        "USA": ["New York", "California", "Texas"],
                        "UK": ["London", "Manchester", "Birmingham"],
                        "Germany": ["Berlin", "Munich", "Hamburg"]
                    }
                }
            };

            // Dynamic Location Selection Logic
            const dynamicSelect = document.getElementById('dynamic-location-select');
            let locationSelection = { region: '', state: '', district: '' };
            let currentSelectionLevel = 'region'; // region, state, district

            function updateDynamicOptions() {
                if (!dynamicSelect) return;
                dynamicSelect.innerHTML = '';

                if (currentSelectionLevel === 'region') {
                    dynamicSelect.innerHTML = `
                        <option value="">Select Region</option>
                        <option value="india">India</option>
                        <option value="nigeria">Nigeria</option>
                        <option value="global">Global</option>
                    `;
                } else if (currentSelectionLevel === 'state') {
                    const country = locationSelection.region;
                    dynamicSelect.innerHTML = `<option value="BACK_TO_REGION">← Back to Regions</option>`;
                    dynamicSelect.innerHTML += `<option value="" disabled selected>Select State (${country.charAt(0).toUpperCase() + country.slice(1)})</option>`;
                    if (locationData[country] && locationData[country].states) {
                        Object.keys(locationData[country].states).forEach(state => {
                            const opt = document.createElement('option');
                            opt.value = state;
                            opt.textContent = state;
                            dynamicSelect.appendChild(opt);
                        });
                    }
                } else if (currentSelectionLevel === 'district') {
                    const country = locationSelection.region;
                    const state = locationSelection.state;
                    dynamicSelect.innerHTML = `<option value="BACK_TO_STATE">← Back to States</option>`;
                    dynamicSelect.innerHTML += `<option value="" disabled selected>Select District (${state})</option>`;
                    if (locationData[country] && locationData[country].states[state]) {
                        locationData[country].states[state].forEach(dist => {
                            const opt = document.createElement('option');
                            opt.value = dist;
                            opt.textContent = dist;
                            dynamicSelect.appendChild(opt);
                        });
                    }
                }
            }

            if (dynamicSelect) {
                dynamicSelect.addEventListener('change', () => {
                    const val = dynamicSelect.value;
                    if (val === 'BACK_TO_REGION') {
                        currentSelectionLevel = 'region';
                        locationSelection = { region: '', state: '', district: '' };
                        updateDynamicOptions();
                        return;
                    }
                    if (val === 'BACK_TO_STATE') {
                        currentSelectionLevel = 'state';
                        locationSelection.state = '';
                        locationSelection.district = '';
                        updateDynamicOptions();
                        return;
                    }

                    if (currentSelectionLevel === 'region' && val) {
                        locationSelection.region = val;
                        currentSelectionLevel = 'state';
                        updateDynamicOptions();
                    } else if (currentSelectionLevel === 'state' && val) {
                        locationSelection.state = val;
                        currentSelectionLevel = 'district';
                        updateDynamicOptions();
                    } else if (currentSelectionLevel === 'district' && val) {
                        locationSelection.district = val;
                        // Keep the selection or maybe show a confirmation?
                        // For now just keep it as is.
                    }
                });
            }

            // Export Popup Logic
            const btnExport = document.getElementById('btn-export');
            const popup = document.getElementById('export-popup');

            if (btnExport && popup) {
                btnExport.addEventListener('click', (e) => {
                    e.stopPropagation();
                    popup.classList.toggle('show');
                });

                document.addEventListener('click', (e) => {
                    if (!popup.contains(e.target) && e.target !== btnExport) {
                        popup.classList.remove('show');
                    }
                });
            }

            // Modal Logic
            const searchInput = document.querySelector('.search-input-wrapper'); // The main search wrapper
            const modalOverlay = document.getElementById('plant-modal-overlay');
            const btnCancel = document.getElementById('btn-cancel-modal');
            const btnConfirm = document.getElementById('btn-confirm-modal');

            if (searchInput && modalOverlay) {
                searchInput.addEventListener('click', () => {
                    if (currentMode === 'reports') {
                        modalOverlay.classList.add('show');
                    }
                });
            }

            if (btnCancel) {
                btnCancel.addEventListener('click', () => {
                    modalOverlay.classList.remove('show');
                });
            }

            // Wire up the main page "Plant" tab to open the modal
            const genTabs = document.querySelectorAll('.gen-tab');
            genTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    if (currentMode === 'reports') {
                        modalOverlay.classList.add('show');
                    }
                });
            });

            // Tab switching logic inside the modal
            const psTabs = document.querySelectorAll('.ps-tab');
            const viewPlant = document.getElementById('view-plant');

            // Dummy Data
            const plantData = [
                { id: 1, name: "BINU", status: "green" },
                { id: 2, name: "Biju Ramachandran", status: "green" },
                { id: 3, name: "CAPITAL ASSOCIATES", status: "green" },
                { id: 4, name: "DR KASIM", status: "green" },
                { id: 5, name: "DR RAVI", status: "green" },
                { id: 6, name: "GIRIJA", status: "gray" },
                { id: 7, name: "Hyfa", status: "green" },
                { id: 8, name: "HARIS", status: "green" },
                { id: 9, name: "Junaid Thalassery", status: "gray" },
                { id: 10, name: "KRISHNAN", status: "green" },
                { id: 11, name: "Karthika", status: "green" },
                { id: 12, name: "MAKKAL", status: "gray" },
                { id: 13, name: "MITHUN", status: "green" },
                { id: 14, name: "MOHAMMAD", status: "green" },
            ];

            // Initialize State
            let currentTab = 'Plant';
            let currentData = plantData; // Default to Plant
            let selectedIds = new Set();

            psTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    psTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    const tabName = tab.textContent.trim();
                    currentTab = tabName;

                    if (viewPlant) {
                        viewPlant.style.display = 'flex';
                        const panelHeader = viewPlant.querySelector('.ps-panel-header span');
                        if (panelHeader) {
                            panelHeader.textContent = `Select ${tabName}`;
                        }
                    }

                    selectedIds.clear(); // Clear selection on tab switch
                    if (tabName === 'SN') {
                        currentData = []; // No data for SN
                    } else if (tabName === 'Plant') {
                        currentData = plantData; // Restore plant data
                    } else {
                        currentData = []; // Default empty
                    }
                    renderLists();
                });
            });

            const helpIcon = document.querySelector('.ps-help-icon');
            const helpNote = document.querySelector('.ps-note');

            if (helpIcon && helpNote) {
                helpIcon.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent bubbling
                    helpNote.classList.toggle('show');
                });

                document.addEventListener('click', (e) => {
                    if (!helpIcon.contains(e.target) && !helpNote.contains(e.target)) {
                        helpNote.classList.remove('show');
                    }
                });
            }

            const filterReportTypeSelect = document.getElementById('filter-report-type');
            const reportsDisplayArea = document.querySelector('.reports-display-area');

            function showNoDataUI() {
                if (reportsDisplayArea) {
                    reportsDisplayArea.style.display = 'flex';
                }
            }

            function hideNoDataUI() {
                if (reportsDisplayArea) {
                    reportsDisplayArea.style.display = 'none';
                }
            }

            if (filterReportTypeSelect) {
                filterReportTypeSelect.addEventListener('change', () => {
                    if (currentMode === 'reports') {
                        const value = filterReportTypeSelect.value;
                        if (value === 'Daily Report' || value === 'Monthly Report' || value === 'Annual Report') {
                            showNoDataUI();
                        } else {
                            hideNoDataUI();
                        }
                    }
                });
                filterReportTypeSelect.dispatchEvent(new Event('change'));
            }

            const sourceListContainer = document.getElementById('ps-source-list');
            const selectedListContainer = document.getElementById('ps-selected-list');
            const btnClearSelection = document.getElementById('btn-clear-selection');

            function renderLists() {
                if (!sourceListContainer || !selectedListContainer) return;

                sourceListContainer.innerHTML = '';
                selectedListContainer.innerHTML = '';

                currentData.forEach(plant => {
                    const item = document.createElement('div');
                    item.className = 'ps-list-item';

                    const leftPart = document.createElement('div');
                    leftPart.className = 'ps-item-left';

                    const dot = document.createElement('span');
                    dot.className = `ps-status-dot ${plant.status}`;

                    const name = document.createElement('span');
                    name.className = 'ps-item-name';
                    name.textContent = plant.name;

                    leftPart.appendChild(dot);
                    leftPart.appendChild(name);
                    item.appendChild(leftPart);

                    if (selectedIds.has(plant.id)) {
                        const removeIcon = document.createElement('i');
                        removeIcon.className = 'fa-solid fa-trash-can ps-action-icon ps-remove-icon';
                        removeIcon.title = 'Remove';
                        removeIcon.onclick = () => {
                            selectedIds.delete(plant.id);
                            renderLists();
                        };
                        item.appendChild(removeIcon);
                        selectedListContainer.appendChild(item);
                    } else {
                        const addIcon = document.createElement('i');
                        addIcon.className = 'fa-solid fa-file-circle-plus ps-action-icon ps-add-icon';
                        addIcon.title = 'Add';
                        addIcon.onclick = () => {
                            selectedIds.add(plant.id);
                            renderLists();
                        };
                        item.appendChild(addIcon);
                        sourceListContainer.appendChild(item);
                    }
                });
            }

            if (btnClearSelection) {
                btnClearSelection.addEventListener('click', () => {
                    selectedIds.clear();
                    renderLists();
                });
            }

            renderLists();

            const noDataView = document.getElementById('no-data-view');
            const resultsView = document.getElementById('report-results-view');
            const tableBody = document.getElementById('report-table-body');
            const tableHead = document.getElementById('report-table-head');
            const resultsTableHeader = document.getElementById('results-table-header');
            const btnGenerateReport = document.getElementById('btn-generate-report');
            const searchTagsContainer = document.getElementById('search-tags-container');

            let reportChartInstance = null;

            function renderChart() {
                const ctx = document.getElementById('reportChart').getContext('2d');

                if (reportChartInstance) {
                    reportChartInstance.destroy();
                }

                const labels = ['15.06.2025', '16.06.2025', '17.06.2025', '18.06.2025', '19.06.2025', '20.06.2025', '21.06.2025', '22.06.2025', '23.06.2025', '24.06.2025', '25.06.2025', '26.06.2025'];
                const barData = [380, 460, 360, 400, 430, 480, 440, 360, 410, 360, 150, 410];
                const lineData = [3900, 4700, 3700, 4100, 4400, 4900, 4500, 3700, 4200, 3700, 1600, 4200];

                reportChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                type: 'line',
                                label: 'Income ($)',
                                data: lineData,
                                borderColor: '#4db6ac',
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                yAxisID: 'y1',
                                order: 1
                            },
                            {
                                type: 'bar',
                                label: 'Generation (kWh)',
                                data: barData,
                                backgroundColor: '#4db6ac',
                                hoverBackgroundColor: '#26a69a',
                                borderRadius: 4,
                                barPercentage: 0.6,
                                categoryPercentage: 0.8,
                                yAxisID: 'y',
                                order: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'rectRounded',
                                    boxWidth: 20,
                                    padding: 20,
                                    font: { size: 12 }
                                }
                            }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 10 }, color: '#888' } },
                            y: {
                                beginAtZero: true,
                                position: 'left',
                                max: 600,
                                title: { display: true, text: 'Generation (kWh)', color: '#888', font: { size: 11 } },
                                ticks: { stepSize: 100, color: '#888' },
                                grid: { color: '#f0f0f0' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                max: 6000,
                                beginAtZero: true,
                                grid: { drawOnChartArea: false },
                                title: { display: true, text: 'Income ($)', color: '#888', font: { size: 11 } },
                                ticks: { stepSize: 1000, color: '#888' }
                            }
                        }
                    }
                });
            }

            function updateTableHeader(mode) {
                if (!tableHead) return;
                tableHead.innerHTML = '';

                if (mode === 'reports') {
                    const tr = document.createElement('tr');
                    const headers = ['Date', 'Plant', 'Classification', 'Capacity(kWp)', 'Generation(kWh)', 'Income($)'];
                    resultsTableHeader.textContent = 'Statistics';
                    headers.forEach(text => {
                        const th = document.createElement('th');
                        th.style.padding = '12px';
                        th.style.textAlign = 'left';
                        th.style.border = '1px solid rgba(255,255,255,0.1)';
                        th.textContent = text;
                        tr.appendChild(th);
                    });
                    tableHead.appendChild(tr);
                } else {
                    const monthVal = dateInput.value || '11.2025';
                    resultsTableHeader.textContent = `${monthVal} Generation Statistics`;

                    // Row 1
                    const tr1 = document.createElement('tr');
                    const thOwner = document.createElement('th');
                    thOwner.textContent = 'Owner Info';
                    thOwner.colSpan = 1;
                    thOwner.style.textAlign = 'center';
                    thOwner.style.padding = '8px';
                    thOwner.style.border = '1px solid rgba(255,255,255,0.2)';

                    const thPlant = document.createElement('th');
                    thPlant.textContent = 'Plant Info';
                    thPlant.colSpan = 3;
                    thPlant.style.textAlign = 'center';
                    thPlant.style.padding = '8px';
                    thPlant.style.border = '1px solid rgba(255,255,255,0.2)';

                    const thGen = document.createElement('th');
                    thGen.textContent = 'Generation(kWh)';
                    thGen.colSpan = 3;
                    thGen.style.textAlign = 'center';
                    thGen.style.padding = '8px';
                    thGen.style.border = '1px solid rgba(255,255,255,0.2)';

                    tr1.appendChild(thOwner);
                    tr1.appendChild(thPlant);
                    tr1.appendChild(thGen);
                    tableHead.appendChild(tr1);

                    // Row 2
                    const tr2 = document.createElement('tr');
                    // According to Screenshot 1 and 2, Row 2 should have sub-headers
                    const subHeaders = ['Email', 'Name', 'Capacity (KW)', 'Location', 'Monthly Total', 'Daily Average', 'Total'];
                    subHeaders.forEach(text => {
                        const th = document.createElement('th');
                        th.textContent = text;
                        th.style.padding = '10px';
                        th.style.textAlign = 'center';
                        th.style.fontSize = '12px';
                        th.style.fontWeight = '500';
                        th.style.border = '1px solid rgba(255,255,255,0.1)';
                        tr2.appendChild(th);
                    });
                    tableHead.appendChild(tr2);
                }
            }

            function updateTable(mode) {
                if (!tableBody) return;
                tableBody.innerHTML = '';

                const rowCount = 10;
                for (let i = 0; i < rowCount; i++) {
                    const tr = document.createElement('tr');
                    tr.style.backgroundColor = i % 2 === 0 ? '#fff' : '#fafafa';
                    if (mode === 'reports') {
                        tr.innerHTML = `
                            <td style="padding: 12px; border: 1px solid #eee;">08.01.2025</td>
                            <td style="padding: 12px; border: 1px solid #eee;">Binu</td>
                            <td style="padding: 12px; border: 1px solid #eee;">Residential</td>
                            <td style="padding: 12px; border: 1px solid #eee;">5</td>
                            <td style="padding: 12px; border: 1px solid #eee;">12.3</td>
                            <td style="padding: 12px; border: 1px solid #eee;">104.55</td>
                        `;
                    } else {
                        tr.innerHTML = `
                            <td style="padding: 12px; border: 1px solid #eee; color: #666; font-size: 13px;">binu.alavathil@gmail.com</td>
                            <td style="padding: 12px; border: 1px solid #eee; color: #666; font-size: 13px;">Binu</td>
                            <td style="padding: 12px; border: 1px solid #eee; color: #666; font-size: 13px;">5</td>
                            <td style="padding: 12px; border: 1px solid #eee; color: #666; font-size: 13px;">India_kerala</td>
                            <td style="padding: 12px; border: 1px solid #eee; color: #666; font-size: 13px;">31.0</td>
                            <td style="padding: 12px; border: 1px solid #eee; color: #666; font-size: 13px;">10.4</td>
                            <td style="padding: 12px; border: 1px solid #eee; color: #666; font-size: 13px;">2199</td>
                        `;
                    }
                    tableBody.appendChild(tr);
                }
            }

            function renderSearchTags() {
                if (!searchTagsContainer) return;
                searchTagsContainer.innerHTML = '';

                const plantMap = new Map();
                plantData.forEach(p => plantMap.set(p.id, p.name));

                selectedIds.forEach(id => {
                    const name = plantMap.get(id);
                    if (name) {
                        const tag = document.createElement('div');
                        tag.className = 'ps-search-tag';
                        tag.innerHTML = `
                            <span>${name}</span>
                            <i class="fa-solid fa-xmark ps-search-tag-remove" data-id="${id}"></i>
                        `;
                        tag.querySelector('.ps-search-tag-remove').addEventListener('click', (e) => {
                            e.stopPropagation();
                            const idToRemove = parseInt(e.target.getAttribute('data-id'));
                            selectedIds.delete(idToRemove);
                            renderSearchTags();
                            renderLists();
                        });
                        searchTagsContainer.appendChild(tag);
                    }
                });
            }

            if (btnConfirm) {
                btnConfirm.addEventListener('click', () => {
                    modalOverlay.classList.remove('show');
                    renderSearchTags();
                });
            }

            // Results Step Navigation Logic
            const btnNextStep = document.getElementById('btn-next-step');
            const btnPrevStep = document.getElementById('btn-prev-step');
            const resultsStep2 = document.getElementById('results-step-2');
            const chartSection = resultsView?.querySelector('.chart-section');
            const tableSection = resultsView?.querySelector('.table-section');

            if (btnNextStep && btnPrevStep) {
                btnNextStep.addEventListener('click', () => {
                    if (resultsStep2.style.display === 'none') {
                        // Move to Step 2
                        if (chartSection) chartSection.style.display = 'none';
                        if (tableSection) tableSection.style.display = 'none';
                        resultsStep2.style.display = 'block';
                        btnPrevStep.style.display = 'block';
                        btnNextStep.textContent = 'Finish'; // Optional: change label
                    } else {
                        // Finish or further action
                        alert("Reporting process completed.");
                    }
                });

                btnPrevStep.addEventListener('click', () => {
                    // Back to Step 1
                    resultsStep2.style.display = 'none';
                    if (currentMode === 'reports') {
                        if (chartSection) chartSection.style.display = 'block';
                    }
                    if (tableSection) tableSection.style.display = 'block';
                    btnPrevStep.style.display = 'none';
                    btnNextStep.textContent = 'Next';
                });
            }

            if (btnGenerateReport) {
                btnGenerateReport.addEventListener('click', () => {
                    // Reset to Step 1 when generating new report
                    if (resultsStep2) resultsStep2.style.display = 'none';
                    if (btnPrevStep) btnPrevStep.style.display = 'none';
                    if (btnNextStep) btnNextStep.textContent = 'Next';

                    if (currentMode === 'reports') {
                        if (selectedIds.size > 0) {
                            if (noDataView) noDataView.style.display = 'none';
                            if (resultsView) resultsView.style.display = 'flex';
                            if (chartSection) chartSection.style.display = 'block';
                            if (tableSection) tableSection.style.display = 'block';
                            updateTableHeader('reports');
                            setTimeout(renderChart, 100);
                            updateTable('reports');
                        } else {
                            alert("Please select at least one plant to generate a report.");
                        }
                    } else {
                        const locationSelected = locationSelection.region && locationSelection.state && locationSelection.district;
                        const orgSelected = filterOrganization.value;
                        const monthSelected = dateInput.value;

                        if (locationSelected && orgSelected && monthSelected) {
                            if (noDataView) noDataView.style.display = 'none';
                            if (resultsView) resultsView.style.display = 'flex';
                            if (chartSection) chartSection.style.display = 'none';
                            if (tableSection) tableSection.style.display = 'block';
                            updateTableHeader('statistics');
                            updateTable('statistics');
                        } else {
                            if (noDataView) noDataView.style.display = 'none';
                            if (resultsView) resultsView.style.display = 'flex';
                            if (chartSection) chartSection.style.display = 'none';
                            if (tableSection) tableSection.style.display = 'block';
                            updateTableHeader('statistics', false);
                            tableBody.innerHTML = `
                                <tr>
                                    <td colspan="7" style="text-align:center; padding: 60px; color: #bbb; border: 1px solid #eee; font-size: 28px; font-weight: 500;">
                                        No Data
                                    </td>
                                </tr>
                            `;
                        }
                    }
                });
            }

            updateTableHeader('reports');
        });
    </script>
</body>

</html>